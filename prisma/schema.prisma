generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model ActiveIngredient {
  id                          String                     @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  name                        String                     @unique @db.VarChar(500)
  name_latin                  String?                    @db.VarChar(500)
  name_uzbek                  String?                    @db.VarChar(500)
  atc_code                    String?                    @db.VarChar(20)
  therapeutic_class           String?                    @db.VarChar(500)
  description                 String?
  warnings                    String?
  is_narrow_therapeutic_index Boolean?                   @default(false)
  created_at                  DateTime?                  @default(now()) @db.Timestamp(6)
  updated_at                  DateTime?                  @default(now()) @db.Timestamp(6)
  equivalence_groups          EquivalenceGroup[]
  medicine_active_ingredients MedicineActiveIngredient[]

  @@index([atc_code], map: "idx_active_ingredients_atc")
  @@index([name], map: "idx_active_ingredients_name")
  @@index([name(ops: raw("gin_trgm_ops"))], map: "idx_active_ingredients_name_trgm", type: Gin)
  @@map("active_ingredients")
}

model Manufacturer {
  id                 String     @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  name               String     @unique(map: "manufacturers_name_unique") @db.VarChar(500)
  country            String?    @db.VarChar(200)
  is_local           Boolean?   @default(false)
  reliability_rating Decimal?   @db.Decimal(3, 2)
  created_at         DateTime?  @default(now()) @db.Timestamp(6)
  updated_at         DateTime?  @default(now()) @db.Timestamp(6)
  medicines         Medicine[]

  @@map("manufacturers")
}

model DosageForm {
  id          String     @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  name        String     @unique @db.VarChar(500)
  name_uzbek  String?    @db.VarChar(500)
  description String?
  created_at  DateTime?  @default(now()) @db.Timestamp(6)
  medicines   Medicine[]

  @@map("dosage_forms")
}

model Medicine {
  id                   String                     @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  trade_name           String                     @db.VarChar(500)
  registration_number  String?                    @unique(map: "medicines_registration_number_key") @db.VarChar(200)
  manufacturer_id      String?                    @db.Uuid
  dosage_form_id       String?                    @db.Uuid
  strength             String?                    @db.VarChar(200)
  strength_numeric     Decimal?                   @db.Decimal(10, 4)
  strength_unit        String?                    @db.VarChar(50)
  package_size         String?                    @db.VarChar(200)
  package_quantity     Int?
  price_uzs            Decimal?                   @db.Decimal(12, 2)
  price_last_updated   DateTime?                  @db.Timestamp(6)
  prescription_required Boolean?                   @default(true)
  is_generic           Boolean?                   @default(false)
  is_available         Boolean?                   @default(true)
  barcode              String?                    @db.VarChar(100)
  registration_date    DateTime?                  @db.Date
  expiry_date          DateTime?                  @db.Date
  created_at           DateTime?                  @default(now()) @db.Timestamp(6)
  updated_at           DateTime?                  @default(now()) @db.Timestamp(6)
  medicine_active_ingredients MedicineActiveIngredient[]
  medicine_equivalence        MedicineEquivalence[]
  medicine_prices             MedicinePrice[]
  dosage_forms                DosageForm?                @relation(fields: [dosage_form_id], references: [id], onDelete: NoAction, onUpdate: NoAction, map: "medicines_dosage_form_fkey")
  manufacturers               Manufacturer?              @relation(fields: [manufacturer_id], references: [id], onDelete: NoAction, onUpdate: NoAction, map: "medicines_manufacturer_fkey")
  user_searches               UserSearch[]

  @@index([is_available], map: "idx_medicines_available")
  @@index([dosage_form_id], map: "idx_medicines_dosage_form")
  @@index([manufacturer_id], map: "idx_medicines_manufacturer")
  @@index([price_uzs], map: "idx_medicines_price")
  @@index([strength_numeric, strength_unit], map: "idx_medicines_strength")
  @@index([trade_name], map: "idx_medicines_trade_name")
  @@index([trade_name(ops: raw("gin_trgm_ops"))], map: "idx_medicines_trade_name_trgm", type: Gin)
  @@map("medicines")
}

model MedicineActiveIngredient {
  id                   String            @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  medicine_id          String?           @db.Uuid
  active_ingredient_id String?           @db.Uuid
  quantity             Decimal?          @db.Decimal(10, 4)
  quantity_unit        String?           @db.VarChar(50)
  is_primary           Boolean?          @default(true)
  created_at           DateTime?         @default(now()) @db.Timestamp(6)
  active_ingredients ActiveIngredient? @relation(fields: [active_ingredient_id], references: [id], onDelete: Cascade, onUpdate: NoAction, map: "med_active_ingredients_ingredient_fkey")
  medicines          Medicine?         @relation(fields: [medicine_id], references: [id], onDelete: Cascade, onUpdate: NoAction, map: "med_active_ingredients_medicine_fkey")

  @@unique([medicine_id, active_ingredient_id], map: "med_active_ingredients_unique")
  @@index([active_ingredient_id], map: "idx_med_active_ingredient")
  @@index([medicine_id], map: "idx_med_active_medicine")
  @@map("medicine_active_ingredients")
}

model Pharmacy {
  id         String    @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  name       String    @db.VarChar(255)
  chain_name String?   @db.VarChar(255)
  address    String?
  city       String?   @db.VarChar(100)
  region     String?   @db.VarChar(100)
  phone      String?   @db.VarChar(50)
  latitude   Decimal?  @db.Decimal(10, 8)
  longitude  Decimal?  @db.Decimal(11, 8)
  is_active  Boolean?  @default(true)
  created_at DateTime? @default(now()) @db.Timestamp(6)
  updated_at DateTime? @default(now()) @db.Timestamp(6)
  medicine_prices MedicinePrice[]

  @@map("pharmacies")
}

model MedicinePrice {
  id             String    @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  medicine_id    String?   @db.Uuid
  pharmacy_id    String?   @db.Uuid
  price_uzs      Decimal   @db.Decimal(12, 2)
  is_available   Boolean?  @default(true)
  stock_quantity Int?
  last_verified  DateTime? @default(now()) @db.Timestamp(6)
  created_at     DateTime? @default(now()) @db.Timestamp(6)
  updated_at     DateTime? @default(now()) @db.Timestamp(6)
  medicines     Medicine? @relation(fields: [medicine_id], references: [id], onDelete: Cascade, onUpdate: NoAction, map: "med_prices_medicine_fkey")
  pharmacies    Pharmacy? @relation(fields: [pharmacy_id], references: [id], onDelete: Cascade, onUpdate: NoAction, map: "med_prices_pharmacy_fkey")

  @@unique([medicine_id, pharmacy_id], map: "med_prices_unique")
  @@index([price_uzs], map: "idx_prices_amount")
  @@index([medicine_id], map: "idx_prices_medicine")
  @@index([pharmacy_id], map: "idx_prices_pharmacy")
  @@map("medicine_prices")
}

model UserSearch {
  id            String    @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  search_query  String    @db.VarChar(500)
  medicine_id    String?   @db.Uuid
  user_ip       String?   @db.VarChar(45)
  user_agent     String?
  results_count  Int?
  created_at     DateTime? @default(now()) @db.Timestamp(6)
  medicines    Medicine? @relation(fields: [medicine_id], references: [id], onDelete: NoAction, onUpdate: NoAction, map: "user_searches_medicine_fkey")

  @@index([created_at], map: "idx_searches_created")
  @@index([medicine_id], map: "idx_searches_medicine")
  @@map("user_searches")
}

model EquivalenceGroup {
  id                    String    @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  name                  String    @db.VarChar(255)
  active_ingredient_id  String?   @db.Uuid
  description           String?
  bioequivalence_note   String?
  created_at            DateTime? @default(now()) @db.Timestamp(6)
  active_ingredients   ActiveIngredient?     @relation(fields: [active_ingredient_id], references: [id], onDelete: NoAction, onUpdate: NoAction, map: "equivalence_groups_ingredient_fkey")
  medicine_equivalence MedicineEquivalence[]

  @@map("equivalence_groups")
}

model MedicineEquivalence {
  equivalence_group_id String    @db.Uuid
  medicine_id          String    @db.Uuid
  equivalence_rating   String?   @db.VarChar(20)
  created_at           DateTime? @default(now()) @db.Timestamp(6)
  equivalence_groups EquivalenceGroup @relation(fields: [equivalence_group_id], references: [id], onDelete: Cascade, onUpdate: NoAction, map: "med_equivalence_group_fkey")
  medicines          Medicine         @relation(fields: [medicine_id], references: [id], onDelete: Cascade, onUpdate: NoAction, map: "med_equivalence_medicine_fkey")

  @@id([equivalence_group_id, medicine_id])
  @@map("medicine_equivalence")
}
